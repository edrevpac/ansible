---

- hosts: all

  become: true

  environment:
    JAVA_HOME: /usr/lib/jvm/default-java

  tasks:


#  - name: set jdk environment variables
#    lineinfile:
#      path: ~/.profile
#      line: 'JAVA_HOME=/usr/lib/jvm/default-java'
#      insertbefore: BOF
#    become_user: vagrant

#  - name: set jre environment variables
#    lineinfile:
#      path: ~/.profile
#      line: 'JRE_HOME=/usr/lib/jvm/default-java/jre'
#      insertbefore: BOF
#    become_user: vagrant

#  - name: set maven environment variables
#    lineinfile:
#      path: ~/.profile
#      line: 'M2_HOME=/usr/share/maven/'
#      insertbefore: BOF

#  - name: set maven environment variables
#    lineinfile:
#      path: ~/.profile
#      line: 'M2=/usr/share/maven/bin'
#      insertbefore: BOF

#  - name: set maven environment variables
#    lineinfile:
#      path: ~/.profile
#      line: 'PATH=/usr/share/maven/bin:$PATH'
#      insertbefore: BOF

#  - name: set jenkins home environment variables
#    lineinfile:
#      path: ~/.profile
#      line: 'JENKINS_HOME=/var/lib/jenkins'
#      insertbefore: BOF
#    become_user: vagrant


  - name: start your day
    apt: 
      name: 
        - apt-transport-https
        - default-jdk-headless
      state: present
      update_cache: yes

  - name: remember where you left your keys
    apt_key: 
      url: https://pkg.jenkins.io/debian/jenkins.io.key
      state: present

  - name: make a note not to forget your keys again
    apt_repository:
      repo: deb https://pkg.jenkins.io/debian binary/
      state: present

  - name: get to work and do...
    apt:
      name:
        - git
        - maven
        - jenkins
#        - nginx
      update_cache: yes

  - name: some unrelated misc stuff
    shell: (echo 123 ; sleep 1; echo 123) | passwd jenkins

  - name: press "I Accept" on the 22 page disclaimer and the 68 page T&C and fire up the "thing"
    lineinfile:
      path: /etc/default/jenkins
      line: 'JAVA_ARGS="-Djenkins.install.runSetupWizard=false"'
      insertbefore: BOF

  - name: wait a while and listen, sip cofee, smoke pipe, smile
    wait_for:
      timeout: 60

  - name: some more unrelated misc stuff...
    shell: cat /var/lib/jenkins/secrets/initialAdminPassword
    register: password_var

  - name: do the thing that Alin suggested
    set_fact:
      jenkins_password: '{{ password_var.stdout }}'

  - debug:
      msg: '{{ password_var.stdout }}'

  - name: install a plugin
    jenkins_plugin:
      name: git
      params:
        url: http://192.168.56.196:8080
        url_username: admin
        url_password: '{{ jenkins_password }}'
      state: present

  - name: install another plugin
    jenkins_plugin:
      name: deploy
      params:
        url: http://192.168.56.196:8080
        url_username: admin
        url_password: '{{ jenkins_password }}'
      state: present


  - name: grab some configuration files from wonderland
    get_url: 
      url: https://raw.githubusercontent.com/edrevpac/jenkins/master/{{item}}
      dest: /var/lib/jenkins
      owner: jenkins
      group: jenkins
#      mode: 0755 / u=rw,go=r
    with_items:
      - config.xml
      - credentials.xml
      - hudson.model.Job.serverCookie
      - hudson.model.UpdateCenter.xml
      - hudson.plugins.git.GitSCM.xml
      - hudson.plugins.git.GitTool.xml
      - hudson.tasks.Mailer.xml
      - hudson.tasks.Maven.xml
      - hudson.tasks.Shell.xml
      - hudson.triggers.SCMTrigger.xml
      - jenkins.model.ArtifactManagerConfiguration.xml
      - jenkins.model.DownloadSettings.xml
      - jenkins.model.JenkinsLocationConfiguration.xml
      - jenkins.mvn.GlobalMavenConfig.xml
      - org.jenkinsci.plugins.gitclient.JGitApacheTool.xml
      - org.jenkinsci.plugins.gitclient.JGitTool.xml

  - name: create a work folder
    file:
      path: /var/lib/jenkins/jobs/hello_world
      state: directory
      owner: jenkins
      group: jenkins
#      mode: 0755 / u=rw,go=r

  - name: grab some more work-related files from wonderland
    get_url: 
      url: https://raw.githubusercontent.com/edrevpac/jenkins/master/jobs/hello_world/config.xml
      dest: /var/lib/jenkins/jobs/hello_world
      owner: jenkins
      group: jenkins
#      mode: 0755 / u=rw,go=r

  - name: grab some secret pre-configured files from wonderland ;)
    get_url: 
      url: https://raw.githubusercontent.com/edrevpac/jenkins/master/secrets/{{item}}
      dest: /var/lib/jenkins/secrets
      owner: jenkins
      group: jenkins
#      mode: 0755 / u=rw,go=r
    with_items:
      - master.key
      - hudson.util.Secret

  - name: wait a while and listen, sip cofee, smoke pipe, smile
    wait_for:
      timeout: 10

  - name: restart the "thing"... because why not!
    service:
      name: jenkins
      state: restarted

  - name: wait a while and listen, sip cofee, smoke pipe, smile
    wait_for:
      timeout: 60

#  - name: enable nginx service to run on boot
#    service:
#      name: nginx
#      enabled: yes
#      state: restarted
